# DESCRIPTION:
# Builds, tests and packages the solution for the CI build configuration.
name: $(SourceBranchName)-$(Date:yyyyMMdd)$(Rev:-r)

variables:
- template: aks-variables.yml
- group: DICOM-DEV
- name: imageTag
  value: $[coalesce(variables['specificTag'], variables['build.buildnumber'])]

trigger:
  branches:
    include:
    - master

pr: none

stages:
- stage: PublishContainer
  displayName: 'Publish Docker CI Container'
  jobs:
  - template: ../jobs/docker-build-push.yml
    parameters: 
      version: "Stu3"
      tag: $(imageTag)

- stage: AKSDeploy
  displayName: Deploy to AKS
  jobs:
  - template: ../jobs/helm-deploy.yml
    parameters:
      name: deploy_fhir
      displayName: Deploy FHIR
      environmentName: DICOM-DEV.dicom
      logicalEnvironment: DEV
      chartPath: 'samples/kubernetes/helm/fhir-server'
      releaseName: 'fhir'
      overrideValues: 'image.tag=$(imageTag),database.sql.existing.serverName=$(SQLServerName).database.windows.net,database.sql.existing.databaseName=$(SQLDbName),database.sql.existing.username=$(SQLUsername),database.sql.existing.password=$(SQLServerPassword)'
      valueFile: 'build/aks/values.yml'